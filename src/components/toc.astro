---
import type { MarkdownHeading } from "astro";

interface Props {
  headings: MarkdownHeading[];
}

const { headings = [] } = Astro.props;
---

<div
  class="display-none position-sticky tablet:display-block tablet:grid-col-auto overflow-y-auto overflow-x-hidden padding-top-5 desktop:padding-top-5 padding-bottom-6 tablet:padding-right-3 padding-left-05 margin-left-neg-05"
  style="top: 4rem; height: calc(100vh - 4.5rem); width: 14rem;"
>
  <aside id="toc" class="grid-col-auto maxw-order-last margin-left-auto">
    <h4>On this page</h4>
    <ul class="usa-in-page-nav__list">
      {
        headings.map((heading) => (
          <li class="usa-in-page-nav__item usa-in-page-nav__item--primary">
            <a href={`#${heading.slug}`} class="usa-in-page-nav__link">
              {heading.text}
            </a>
          </li>
        ))
      }
    </ul>
  </aside>
</div>

<script>
  const visibleHeadings = new Set<string>();
  const tocLinks = document.querySelectorAll<HTMLAnchorElement>("#toc a");
  const headings = document.querySelectorAll("main :is(h2,h3,h4,h5,h6)[id]");

  let didScroll = false;
  window.addEventListener("scroll", () => (didScroll = true), { once: true });

  const headingsObserver = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          visibleHeadings.add(entry.target.id);
        } else {
          visibleHeadings.delete(entry.target.id);
        }
      });

      const activeId = didScroll
        ? [...visibleHeadings].pop()
        : [...visibleHeadings][0];

      if (visibleHeadings.size > 0) {
        tocLinks.forEach((el) =>
          el.classList.toggle(
            "usa-current",
            el.getAttribute("href") === `#${activeId}`,
          ),
        );
      }
    },
    {
      rootMargin: "-100px 0px",
      threshold: 1,
    },
  );

  const tocHeadingIds = Array.from(tocLinks)
    .map((link) => link.getAttribute("href")?.replace("#", ""))
    .filter(Boolean);

  Array.from(headings)
    .filter((heading) => tocHeadingIds.includes(heading.id))
    .forEach((heading) => headingsObserver.observe(heading));

  tocLinks.forEach((el) => {
    el.addEventListener("click", (e) => {
      // Prevent USWDS event from firing
      e.stopImmediatePropagation();
      // Restore native click behavior, since USWDS overrides this by default on this component
      document.location.href = el.getAttribute("href") || "#";
    });
  });
</script>
