---
import type { MarkdownHeading } from 'astro'

interface Props {
  headings: MarkdownHeading[]
}

const { headings = [] } = Astro.props
---

<aside
  id="toc"
  class="margin-top-0 overflow-y-auto padding-y-6 position-sticky display-none desktop-lg:display-block margin-left-4 maxw-card-lg"
  style="top: 5.75rem; height: calc(100vh - 6rem);"
>
  <nav class="padding-1" aria-labelledby="toc-heading">
    <h3 class="margin-bottom-2 font-sans-2xs" id="toc-heading">On this page</h3>
    <ul class="usa-in-page-nav__list">
      {
        headings.map((heading) => (
          <li class:list={['usa-in-page-nav__item', heading.depth < 3 ? 'usa-in-page-nav__item--primary' : '']}>
            <a href={`#${heading.slug}`} class="usa-in-page-nav__link">
              {heading.text}
            </a>
          </li>
        ))
      }
    </ul>
  </nav>
</aside>

<script>
  const visibleHeadingIds = new Set<string>()
  const tocLinks = document.querySelectorAll<HTMLAnchorElement>('#toc a')
  const headings = document.querySelectorAll('main :is(h2,h3,h4,h5,h6)[id]')

  let didScroll = false
  window.addEventListener('scroll', () => (didScroll = true), { once: true })

  const headingsObserver = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          visibleHeadingIds.add(entry.target.id)
        }
 else {
          visibleHeadingIds.delete(entry.target.id)
        }
      })

      // As a user scrolls, get the latest id to enter the viewport
      // When the page first loads, get the first/top-most id in the viewport
      const activeId = didScroll ? [...visibleHeadingIds].pop() : [...visibleHeadingIds][0]

      if (visibleHeadingIds.size > 0) {
        tocLinks.forEach((el) => el.classList.toggle('usa-current', el.getAttribute('href') === `#${activeId}`))
      }
    },
    {
      rootMargin: '-100px 0px',
      threshold: 1,
    },
  )

  const tocHeadingIds = Array.from(tocLinks)
    .map((link) => link.getAttribute('href')?.replace('#', ''))
    .filter(Boolean)

  Array.from(headings)
    .filter((heading) => tocHeadingIds.includes(heading.id))
    .forEach((heading) => headingsObserver.observe(heading))

  tocLinks.forEach((el) => {
    el.addEventListener('click', (e) => {
      // Prevent USWDS event from firing
      e.stopImmediatePropagation()
      // Restore native click behavior, since USWDS overrides this by default on this component
      document.location.href = el.getAttribute('href') || '#'
    })
  })
</script>
