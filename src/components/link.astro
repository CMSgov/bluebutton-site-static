---
import { $path } from 'astro-typesafe-routes/path'
import { button } from '#utils/cva/button'
import type { RouteId } from 'astro-typesafe-routes/path'
import type { HTMLAttributes } from 'astro/types'
import type { VariantProps } from 'cva'
import type { HrefOrTo } from '#utils/types'

type Props<T extends RouteId> = Omit<HTMLAttributes<'a'>, 'href'> &
  VariantProps<typeof button> & {
    showIcon?: boolean
  } & HrefOrTo<T>

const props = Astro.props as Props<RouteId>

let isExternal = false
let computedHref: string

if ('to' in props && props.to) {
  // Explicit internal link using "to" prop (preferred for Astro templates)
  isExternal = false
  computedHref = $path(props)
} else if ('href' in props && props.href) {
  // Handle href - could be external or internal (from MDX)
  const hrefString = props.href.toString()

  // Check if it's an external URL
  if (hrefString.startsWith('http')) {
    isExternal = true
    computedHref = hrefString
  } else {
    // Internal link (from MDX)
    isExternal = false
    computedHref = hrefString
  }
} else {
  throw new Error('Link component requires either "href" or "to" prop')
}

const { variant = 'link', size, showIcon = true, class: className, ...restProps } = props
---

<a
  href={computedHref}
  target={isExternal ? '_blank' : undefined}
  rel={isExternal && !computedHref?.includes('cms.gov') ? 'noreferrer' : undefined}
  class:list={[button({ variant, size }), isExternal && showIcon ? 'usa-link--external' : '', className]}
  {...restProps}><slot /></a
>
