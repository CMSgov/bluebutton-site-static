---
import LaunchSvg from '#assets/uswds/img/usa-icons/launch.svg'
import { $path, type RouteId } from 'astro-typesafe-routes/path'
import { undefined } from 'astro:schema'
import { button } from 'utils/cva/button'
import type { LinkProps } from 'utils/types'

type Props<T extends RouteId> = LinkProps<T>

const {
  href,
  to,
  params,
  search,
  searchParams,
  hash,
  trailingSlash,
  variant = 'link',
  size = 'medium',
  showIcon = true,
  ...props
} = Astro.props

let isExternal = false
let computedHref = href
let computedTo = to

if (href) {
  try {
    const { hostname } = new URL(href || '')

    if (hostname === Astro.site?.hostname) {
      console.warn(`${href} is an internal link! Use 'to' instead of 'href'.`)
    } else {
      isExternal = true
    }
  } catch {
    // new URL() throws when it recieves a relative path
    isExternal = false
    computedTo = href
  }
}

if (!isExternal) {
  computedHref = $path({
    to: computedTo,
    params,
    search,
    searchParams,
    hash,
    trailingSlash,
  })

  if (typeof computedHref === 'undefined') {
    throw new Error(`${computedTo} is a bad link!`)
  }
}
---

<a
  href={computedHref}
  target={isExternal ? '_blank' : undefined}
  rel={isExternal && !computedHref.includes('cms.gov') ? 'noopener' : undefined}
  class={button({ variant, size })}
  {...props}
>
  <slot />{
    isExternal && showIcon ? (
      <LaunchSvg height={16} width={16} fill="currentColor" style="vertical-align:middle;" class="margin-left-05" />
    ) : null
  }</a
>
