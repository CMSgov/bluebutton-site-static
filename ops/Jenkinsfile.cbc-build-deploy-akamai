pipeline {
  agent {
    kubernetes {
      defaultContainer "bb2-cbc-build"
      yamlFile "ops/cbc-build.yaml"
    }
  }

  environment {
    AWS_ACCESS_KEY_ID = credentials("bb2-aws-key-id")
    AWS_SECRET_ACCESS_KEY = credentials("bb2-aws-key-secret")
    AWS_DEFAULT_REGION = "us-east-1"
    AKAMAI_SCP_SSH_KEY = credentials("bb2-akamai-scp-ssh-key")
    AKAMAI_SSH_USER = credentials("bb2-akamai-ssh-user")
  }

  parameters {
    choice(
      name: "SITE_ENV",
      choices: ["test", "staging"],
      description: "The environment to build and deploy to."
    )
  }

  stages {
    stage("Notify Slack") {
      steps {
        script {
          helpers = load "ops/helpers.groovy"
          helpers.slackNotify "STARTING - ENV:${params.SITE_ENV}"
        }
      }
    }

    stage("Display Environment") {
      steps {
        script {
          echo("SITE_ENV is set to ${params.SITE_ENV}, proceeding.")
        }
      }
    }

    stage("Checkout release tag") {
      steps {
          sh '''
            git config --add remote.origin.fetch +refs/heads/uswds-redesign:refs/remotes/origin/uswds-redesign
            git fetch
            git checkout uswds-redesign
          '''
      }
    }

    stage("Determine Akamai NetStorage path") {
      steps {
        script {
          echo "Setting UPLOAD_LOCATION from SITE_ENV"
          if (params.SITE_ENV == "test") {
            UPLOAD_LOCATION = "/1197010/test.static.bluebutton.cms.gov/"
          } else if (params.SITE_ENV == "staging") {
            UPLOAD_LOCATION = "/1197010/staging.bluebutton.cms.gov/"
          } else {
            error("Please set SITE_ENV to one of: [test, staging]")
          }
        }
      }
    }

    stage("Run NPM Install") {
      steps {
        sh """
        npm install
        """
      }
    }

    stage("Run Build script") {
      steps {
        sh """
        npm run build
        """
      }
    }

    stage("Deploy Static Site to Akamai NetStorage (rsync)") {
      steps {
        sh """
        rsync -av -e "ssh -oHostKeyAlgorithms=+ssh-dss -oStrictHostKeyChecking=no -i ${AKAMAI_SCP_SSH_KEY}" ./dist/ ${AKAMAI_SSH_USER}@bluebuttoncms.rsync.upload.akamai.com:${UPLOAD_LOCATION} --delete
        """
      }
    }
  }

  post {
    success {
      script {
        helpers.slackNotify("SUCCESS - ENV:${params.SITE_ENV}", "good")
      }
    }

    failure {
      script {
        helpers.slackNotify("FAILURE - ENV:${params.SITE_ENV}", "bad")
      }
    }
  }
}